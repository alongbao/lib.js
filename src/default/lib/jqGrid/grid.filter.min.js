(function(a){a.fn.jqFilter=function(b){if(typeof b=="string"){var c=a.fn.jqFilter[b];if(!c)throw"jqFilter - No such method: "+b;var d=a.makeArray(arguments).slice(1);return c.apply(this,d)}var e=a.extend(!0,{filter:null,columns:[],onChange:null,afterRedraw:null,checkValues:null,error:!1,errmsg:"",errorcheck:!0,showQuery:!0,sopt:null,ops:[{name:"eq",description:"equal",operator:"="},{name:"ne",description:"not equal",operator:"<>"},{name:"lt",description:"less",operator:"<"},{name:"le",description:"less or equal",operator:"<="},{name:"gt",description:"greater",operator:">"},{name:"ge",description:"greater or equal",operator:">="},{name:"bw",description:"begins with",operator:"LIKE"},{name:"bn",description:"does not begin with",operator:"NOT LIKE"},{name:"in",description:"in",operator:"IN"},{name:"ni",description:"not in",operator:"NOT IN"},{name:"ew",description:"ends with",operator:"LIKE"},{name:"en",description:"does not end with",operator:"NOT LIKE"},{name:"cn",description:"contains",operator:"LIKE"},{name:"nc",description:"does not contain",operator:"NOT LIKE"},{name:"nu",description:"is null",operator:"IS NULL"},{name:"nn",description:"is not null",operator:"IS NOT NULL"}],numopts:["eq","ne","lt","le","gt","ge","nu","nn","in","ni"],stropts:["eq","ne","bw","bn","ew","en","cn","nc","nu","nn","in","ni"],_gridsopt:[],groupOps:["AND","OR"],groupButton:!0,ruleButtons:!0},b||{});return this.each(function(){if(!this.filter){this.p=e;if(this.p.filter===null||this.p.filter===undefined)this.p.filter={groupOp:this.p.groupOps[0],rules:[],groups:[]};var b,c=this.p.columns.length,d,f=/msie/i.test(navigator.userAgent)&&!window.opera;if(this.p._gridsopt.length)for(b=0;b<this.p._gridsopt.length;b++)this.p.ops[b].description=this.p._gridsopt[b];this.p.initFilter=a.extend(!0,{},this.p.filter);if(!c)return;for(b=0;b<c;b++)d=this.p.columns[b],d.stype?d.inputtype=d.stype:d.inputtype||(d.inputtype="text"),d.sorttype?d.searchtype=d.sorttype:d.searchtype||(d.searchtype="string"),d.hidden===undefined&&(d.hidden=!1),d.label||(d.label=d.name),d.index&&(d.name=d.index),d.hasOwnProperty("searchoptions")||(d.searchoptions={}),d.hasOwnProperty("searchrules")||(d.searchrules={});this.p.showQuery&&a(this).append("<table class='queryresult ui-widget ui-widget-content' style='display:block;max-width:440px;border:0px none;'><tbody><tr><td class='query'></td></tr></tbody></table>");var g=function(b,c){var d=[!0,""];if(a.isFunction(c.searchrules))d=c.searchrules(b,c);else if(a.jgrid&&a.jgrid.checkValues)try{d=a.jgrid.checkValues(b,-1,null,c.searchrules,c.label)}catch(f){}d&&d.length&&d[0]===!1&&(e.error=!d[0],e.errmsg=d[1])};this.onchange=function(){this.p.error=!1,this.p.errmsg="";return a.isFunction(this.p.onChange)?this.p.onChange.call(this,this.p):!1},this.reDraw=function(){a("table.group:first",this).remove();var b=this.createTableForGroup(e.filter,null);a(this).append(b),a.isFunction(this.p.afterRedraw)&&this.p.afterRedraw.call(this,this.p)},this.createTableForGroup=function(b,c){var d=this,f,g=a("<table class='group ui-widget ui-widget-content' style='border:0px none;'><tbody></tbody></table>");c===null&&a(g).append("<tr class='error' style='display:none;'><th colspan='5' class='ui-state-error' align='left'></th></tr>");var h=a("<tr></tr>");a(g).append(h);var i=a("<th colspan='5' align='left'></th>");h.append(i);if(this.p.ruleButtons===!0){var j=a("<select class='opsel'></select>");i.append(j);var k="",l;for(f=0;f<e.groupOps.length;f++)l=b.groupOp===d.p.groupOps[f]?" selected='selected'":"",k+="<option value='"+d.p.groupOps[f]+"'"+l+">"+d.p.groupOps[f]+"</option>";j.append(k).bind("change",function(){b.groupOp=a(j).val(),d.onchange()})}var m="<span></span>";this.p.groupButton&&(m=a("<input type='button' value='+ {}' title='Add subgroup' class='add-group'/>"),m.bind("click",function(){b.groups===undefined&&(b.groups=[]),b.groups.push({groupOp:e.groupOps[0],rules:[],groups:[]}),d.reDraw(),d.onchange();return!1})),i.append(m);if(this.p.ruleButtons===!0){var n=a("<input type='button' value='+' title='Add rule' class='add-rule ui-add'/>"),o;n.bind("click",function(){b.rules===undefined&&(b.rules=[]);for(f=0;f<d.p.columns.length;f++){var a=typeof d.p.columns[f].search=="undefined"?!0:d.p.columns[f].search,c=d.p.columns[f].hidden===!0,e=d.p.columns[f].searchoptions.searchhidden===!0;if(e&&a||a&&!c){o=d.p.columns[f];break}}var g;o.searchoptions.sopt?g=o.searchoptions.sopt:d.p.sopt?g=d.p.sopt:o.searchtype==="string"?g=d.p.stropts:g=d.p.numopts,b.rules.push({field:o.name,op:g[0],data:""}),d.reDraw();return!1}),i.append(n)}if(c!==null){var q=a("<input type='button' value='-' title='Delete group' class='delete-group'/>");i.append(q),q.bind("click",function(){for(f=0;f<c.groups.length;f++)if(c.groups[f]===b){c.groups.splice(f,1);break}d.reDraw(),d.onchange();return!1})}if(b.groups!==undefined)for(f=0;f<b.groups.length;f++){var r=a("<tr></tr>");g.append(r);var s=a("<td class='first'></td>");r.append(s);var t=a("<td colspan='4'></td>");t.append(this.createTableForGroup(b.groups[f],b)),r.append(t)}b.groupOp===undefined&&(b.groupOp=d.p.groupOps[0]);if(b.rules!==undefined)for(f=0;f<b.rules.length;f++)g.append(this.createTableRowForRule(b.rules[f],b));return g},this.createTableRowForRule=function(b,c){var d=this,g=a("<tr></tr>"),h,i,j,k,l="",m;g.append("<td class='first'></td>");var n=a("<td class='columns'></td>");g.append(n);var o=a("<select></select>"),q,r=[];n.append(o),o.bind("change",function(){b.field=a(o).val(),j=a(this).parents("tr:first");for(h=0;h<d.p.columns.length;h++)if(d.p.columns[h].name===b.field){k=d.p.columns[h];break}if(!!k){k.searchoptions.id=a.jgrid.randId(),f&&k.inputtype==="text"&&(k.searchoptions.size||(k.searchoptions.size=10));var c=a.jgrid.createEl(k.inputtype,k.searchoptions,"",!0,d.p.ajaxSelectOptions,!0);a(c).addClass("input-elm"),k.searchoptions.sopt?i=k.searchoptions.sopt:d.p.sopt?i=d.p.sopt:k.searchtype==="string"?i=d.p.stropts:i=d.p.numopts;var e="",g="";r=[],a.each(d.p.ops,function(){r.push(this.name)});for(h=0;h<i.length;h++)q=a.inArray(i[h],r),q!==-1&&(g="",h===0&&(b.op=d.p.ops[q].name,g=" selected='selected'"),e+="<option value='"+d.p.ops[q].name+"'"+g+">"+d.p.ops[q].description+"</option>");a(".selectopts",j).empty().append(e),a(".data",j).empty().append(c),a(".input-elm",j).bind("change",function(){b.data=a(this).val(),d.onchange()}),setTimeout(function(){b.data=a(c).val(),d.onchange()},0)}});var s=0;for(h=0;h<d.p.columns.length;h++){var t=typeof d.p.columns[h].search=="undefined"?!0:d.p.columns[h].search,u=d.p.columns[h].hidden===!0,v=d.p.columns[h].searchoptions.searchhidden===!0;if(v&&t||t&&!u)m="",b.field===d.p.columns[h].name&&(m=" selected='selected'",s=h),l+="<option value='"+d.p.columns[h].name+"'"+m+">"+d.p.columns[h].label+"</option>"}o.append(l);var w=a("<td class='operators'></td>");g.append(w),k=e.columns[s],k.searchoptions.id=a.jgrid.randId(),f&&k.inputtype==="text"&&(k.searchoptions.size||(k.searchoptions.size=10));var x=a.jgrid.createEl(k.inputtype,k.searchoptions,b.data,!0,d.p.ajaxSelectOptions,!0),y=a("<select class='selectopts'></select>");w.append(y),y.bind("change",function(){b.op=a(y).val(),j=a(this).parents("tr:first");var c=a(".input-elm",j)[0];b.op==="nu"||b.op==="nn"?(b.data="",c.value="",c.setAttribute("readonly","true"),c.setAttribute("disabled","true")):(c.removeAttribute("readonly"),c.removeAttribute("disabled")),d.onchange()}),k.searchoptions.sopt?i=k.searchoptions.sopt:d.p.sopt?i=d.p.sopt:k.searchtype==="string"?i=e.stropts:i=d.p.numopts,l="",a.each(d.p.ops,function(){r.push(this.name)});for(h=0;h<i.length;h++)q=a.inArray(i[h],r),q!==-1&&(m=b.op===d.p.ops[q].name?" selected='selected'":"",l+="<option value='"+d.p.ops[q].name+"'"+m+">"+d.p.ops[q].description+"</option>");y.append(l);var z=a("<td class='data'></td>");g.append(z),z.append(x),a(x).addClass("input-elm").bind("change",function(){b.data=a(this).val(),d.onchange()});var A=a("<td></td>");g.append(A);if(this.p.ruleButtons===!0){var B=a("<input type='button' value='-' title='Delete rule' class='delete-rule ui-del'/>");A.append(B),B.bind("click",function(){for(h=0;h<c.rules.length;h++)if(c.rules[h]===b){c.rules.splice(h,1);break}d.reDraw(),d.onchange();return!1})}return g},this.getStringForGroup=function(a){var b="(",c;if(a.groups!==undefined)for(c=0;c<a.groups.length;c++){b.length>1&&(b+=" "+a.groupOp+" ");try{b+=this.getStringForGroup(a.groups[c])}catch(d){alert(d)}}if(a.rules!==undefined)try{for(c=0;c<a.rules.length;c++)b.length>1&&(b+=" "+a.groupOp+" "),b+=this.getStringForRule(a.rules[c])}catch(e){alert(e)}b+=")";return b==="()"?"":b},this.getStringForRule=function(b){var c="",d="",f,h,i,j,k=["int","integer","float","number","currency"];for(f=0;f<this.p.ops.length;f++)if(this.p.ops[f].name===b.op){c=this.p.ops[f].operator,d=this.p.ops[f].name;break}for(f=0;f<this.p.columns.length;f++)if(this.p.columns[f].name===b.field){h=this.p.columns[f];break}j=b.data;if(d==="bw"||d==="bn")j=j+"%";if(d==="ew"||d==="en")j="%"+j;if(d==="cn"||d==="nc")j="%"+j+"%";if(d==="in"||d==="ni")j=" ("+j+")";e.errorcheck&&g(b.data,h),a.inArray(h.searchtype,k)!==-1||d==="nn"||d==="nu"?i=b.field+" "+c+" "+j:i=b.field+" "+c+' "'+j+'"';return i},this.resetFilter=function(){this.p.filter=a.extend(!0,{},this.p.initFilter),this.reDraw(),this.onchange()},this.hideError=function(){a("th.ui-state-error",this).html(""),a("tr.error",this).hide()},this.showError=function(){a("th.ui-state-error",this).html(this.p.errmsg),a("tr.error",this).show()},this.toUserFriendlyString=function(){return this.getStringForGroup(e.filter)},this.toString=function(){function c(a){var d="(",e;if(a.groups!==undefined)for(e=0;e<a.groups.length;e++)d.length>1&&(a.groupOp==="OR"?d+=" || ":d+=" && "),d+=c(a.groups[e]);if(a.rules!==undefined)for(e=0;e<a.rules.length;e++)d.length>1&&(a.groupOp==="OR"?d+=" || ":d+=" && "),d+=b(a.rules[e]);d+=")";return d==="()"?"":d}function b(b){if(a.p.errorcheck){var c,d;for(c=0;c<a.p.columns.length;c++)if(a.p.columns[c].name===b.field){d=a.p.columns[c];break}d&&g(b.data,d)}return b.op+"(item."+b.field+",'"+b.data+"')"}var a=this;return c(this.p.filter)},this.reDraw(),this.p.showQuery&&this.onchange(),this.filter=!0}})},a.extend(a.fn.jqFilter,{toSQLString:function(){var a="";this.each(function(){a=this.toUserFriendlyString()});return a},filterData:function(){var a;this.each(function(){a=this.p.filter});return a},getParameter:function(a){if(a!==undefined&&this.p.hasOwnProperty(a))return this.p[a];return this.p},resetFilter:function(){return this.each(function(){this.resetFilter()})},addFilter:function(a){typeof a=="string"&&(a=jQuery.jgrid.parse(a)),this.each(function(){this.p.filter=a,this.reDraw(),this.onchange()})}})})(jQuery)