(function(a){a.jgrid.extend({setTreeNode:function(b,c){return this.each(function(){var d=this;if(!!d.grid&&!!d.p.treeGrid){var e=d.p.expColInd,f=d.p.treeReader.expanded_field,g=d.p.treeReader.leaf_field,h=d.p.treeReader.level_field,j=d.p.treeReader.icon_field,k=d.p.treeReader.loaded,l,m,n,o,p,q,r,s;while(b<c){var t=d.rows[b].id,u=d.p._index[t],v;r=d.p.data[u],d.p.treeGridModel=="nested"&&(r[g]||(l=parseInt(r[d.p.treeReader.left_field],10),m=parseInt(r[d.p.treeReader.right_field],10),r[g]=m===l+1?"true":"false",d.rows[b].cells[d.p._treeleafpos].innerHTML=r[g])),n=parseInt(r[h],10),d.p.tree_root_level===0?(o=n+1,p=n):(o=n,p=n-1),q="<div class='tree-wrap tree-wrap-"+d.p.direction+"' style='width:"+o*18+"px;'>",q+="<div style='"+(d.p.direction=="rtl"?"right:":"left:")+p*18+"px;' class='ui-icon ",r[k]!==undefined&&(r[k]=="true"||r[k]===!0?r[k]=!0:r[k]=!1),r[g]=="true"||r[g]===!0?(q+=(r[j]!==undefined&&r[j]!==""?r[j]:d.p.treeIcons.leaf)+" tree-leaf treeclick'",r[g]=!0,s="leaf"):(r[g]=!1,s=""),r[f]=(r[f]=="true"||r[f]===!0?!0:!1)&&r[k],r[f]===!0?q+=d.p.treeIcons.minus+" tree-minus treeclick'":q+=d.p.treeIcons.plus+" tree-plus treeclick'",q+="</div></div>",a(d.rows[b].cells[e]).wrapInner("<span class='cell-wrapper"+s+"'></span>").prepend(q);if(n!==parseInt(d.p.tree_root_level,10)){var w=a(d).jqGrid("getNodeParent",r);v=w&&w.hasOwnProperty(f)?w[f]:!0,v||a(d.rows[b]).css("display","none")}a(d.rows[b].cells[e]).find("div.treeclick").bind("click",function(b){var c=b.target||b.srcElement,e=a(c,d.rows).closest("tr.jqgrow")[0].id,h=d.p._index[e];d.p.data[h][g]||(d.p.data[h][f]?(a(d).jqGrid("collapseRow",d.p.data[h]),a(d).jqGrid("collapseNode",d.p.data[h])):(a(d).jqGrid("expandRow",d.p.data[h]),a(d).jqGrid("expandNode",d.p.data[h])));return!1}),d.p.ExpandColClick===!0&&a(d.rows[b].cells[e]).find("span.cell-wrapper").css("cursor","pointer").bind("click",function(b){var c=b.target||b.srcElement,e=a(c,d.rows).closest("tr.jqgrow")[0].id,h=d.p._index[e];d.p.data[h][g]||(d.p.data[h][f]?(a(d).jqGrid("collapseRow",d.p.data[h]),a(d).jqGrid("collapseNode",d.p.data[h])):(a(d).jqGrid("expandRow",d.p.data[h]),a(d).jqGrid("expandNode",d.p.data[h]))),a(d).jqGrid("setSelection",e);return!1}),b++}}})},setTreeGrid:function(){return this.each(function(){var b=this,c=0,d,e=!1,f,g,h=[];if(!!b.p.treeGrid){b.p.treedatatype||a.extend(b.p,{treedatatype:b.p.datatype}),b.p.subGrid=!1,b.p.altRows=!1,b.p.pgbuttons=!1,b.p.pginput=!1,b.p.gridview=!0,b.p.multiselect=!1,b.p.rowList=[],b.p.expColInd=0,d="ui-icon-triangle-1-"+(b.p.direction=="rtl"?"w":"e"),b.p.treeIcons=a.extend({plus:d,minus:"ui-icon-triangle-1-s",leaf:"ui-icon-radio-off"},b.p.treeIcons||{}),b.p.treeGridModel=="nested"?b.p.treeReader=a.extend({level_field:"level",left_field:"lft",right_field:"rgt",leaf_field:"isLeaf",expanded_field:"expanded",loaded:"loaded",icon_field:"icon"},b.p.treeReader):b.p.treeGridModel=="adjacency"&&(b.p.treeReader=a.extend({level_field:"level",parent_id_field:"parent",leaf_field:"isLeaf",expanded_field:"expanded",loaded:"loaded",icon_field:"icon"},b.p.treeReader));for(g in b.p.colModel)if(b.p.colModel.hasOwnProperty(g)){f=b.p.colModel[g].name,f==b.p.ExpandColumn&&!e&&(e=!0,b.p.expColInd=c),c++;for(var i in b.p.treeReader)b.p.treeReader[i]==f&&h.push(f)}a.each(b.p.treeReader,function(d,e){e&&a.inArray(e,h)===-1&&(d==="leaf_field"&&(b.p._treeleafpos=c),c++,b.p.colNames.push(e),b.p.colModel.push({name:e,width:1,hidden:!0,sortable:!1,resizable:!1,hidedlg:!0,editable:!0,search:!1}))})}})},expandRow:function(b){this.each(function(){var c=this;if(!!c.grid&&!!c.p.treeGrid){var d=a(c).jqGrid("getNodeChildren",b),e=c.p.treeReader.expanded_field;a(d).each(function(b){var d=a.jgrid.getAccessor(this,c.p.localReader.id);a("#"+d,c.grid.bDiv).css("display",""),this[e]&&a(c).jqGrid("expandRow",this)})}})},collapseRow:function(b){this.each(function(){var c=this;if(!!c.grid&&!!c.p.treeGrid){var d=a(c).jqGrid("getNodeChildren",b),e=c.p.treeReader.expanded_field;a(d).each(function(b){var d=a.jgrid.getAccessor(this,c.p.localReader.id);a("#"+d,c.grid.bDiv).css("display","none"),this[e]&&a(c).jqGrid("collapseRow",this)})}})},getRootNodes:function(){var b=[];this.each(function(){var c=this;if(!!c.grid&&!!c.p.treeGrid)switch(c.p.treeGridModel){case"nested":var d=c.p.treeReader.level_field;a(c.p.data).each(function(a){parseInt(this[d],10)===parseInt(c.p.tree_root_level,10)&&b.push(this)});break;case"adjacency":var e=c.p.treeReader.parent_id_field;a(c.p.data).each(function(a){(this[e]===null||String(this[e]).toLowerCase()=="null")&&b.push(this)})}});return b},getNodeDepth:function(b){var c=null;this.each(function(){if(!!this.grid&&!!this.p.treeGrid){var d=this;switch(d.p.treeGridModel){case"nested":var e=d.p.treeReader.level_field;c=parseInt(b[e],10)-parseInt(d.p.tree_root_level,10);break;case"adjacency":c=a(d).jqGrid("getNodeAncestors",b).length}}});return c},getNodeParent:function(b){var c=null;this.each(function(){var d=this;if(!!d.grid&&!!d.p.treeGrid)switch(d.p.treeGridModel){case"nested":var e=d.p.treeReader.left_field,f=d.p.treeReader.right_field,g=d.p.treeReader.level_field,h=parseInt(b[e],10),i=parseInt(b[f],10),j=parseInt(b[g],10);a(this.p.data).each(function(){if(parseInt(this[g],10)===j-1&&parseInt(this[e],10)<h&&parseInt(this[f],10)>i){c=this;return!1}});break;case"adjacency":var k=d.p.treeReader.parent_id_field,l=d.p.localReader.id;a(this.p.data).each(function(a,d){if(this[l]==b[k]){c=this;return!1}})}});return c},getNodeChildren:function(b){var c=[];this.each(function(){var d=this;if(!!d.grid&&!!d.p.treeGrid)switch(d.p.treeGridModel){case"nested":var e=d.p.treeReader.left_field,f=d.p.treeReader.right_field,g=d.p.treeReader.level_field,h=parseInt(b[e],10),i=parseInt(b[f],10),j=parseInt(b[g],10);a(this.p.data).each(function(a){parseInt(this[g],10)===j+1&&parseInt(this[e],10)>h&&parseInt(this[f],10)<i&&c.push(this)});break;case"adjacency":var k=d.p.treeReader.parent_id_field,l=d.p.localReader.id;a(this.p.data).each(function(a,d){this[k]==b[l]&&c.push(this)})}});return c},getFullTreeNode:function(b){var c=[];this.each(function(){var d=this,e;if(!!d.grid&&!!d.p.treeGrid)switch(d.p.treeGridModel){case"nested":var f=d.p.treeReader.left_field,g=d.p.treeReader.right_field,h=d.p.treeReader.level_field,i=parseInt(b[f],10),j=parseInt(b[g],10),k=parseInt(b[h],10);a(this.p.data).each(function(a){parseInt(this[h],10)>=k&&parseInt(this[f],10)>=i&&parseInt(this[f],10)<=j&&c.push(this)});break;case"adjacency":if(b){c.push(b);var l=d.p.treeReader.parent_id_field,m=d.p.localReader.id;a(this.p.data).each(function(a){e=c.length;for(a=0;a<e;a++)if(c[a][m]==this[l]){c.push(this);break}})}}});return c},getNodeAncestors:function(b){var c=[];this.each(function(){if(!!this.grid&&!!this.p.treeGrid){var d=a(this).jqGrid("getNodeParent",b);while(d)c.push(d),d=a(this).jqGrid("getNodeParent",d)}});return c},isVisibleNode:function(b){var c=!0;this.each(function(){var d=this;if(!!d.grid&&!!d.p.treeGrid){var e=a(d).jqGrid("getNodeAncestors",b),f=d.p.treeReader.expanded_field;a(e).each(function(){c=c&&this[f];if(!c)return!1})}});return c},isNodeLoaded:function(b){var c;this.each(function(){var d=this;if(!!d.grid&&!!d.p.treeGrid){var e=d.p.treeReader.leaf_field;b!==undefined?b.loaded!==undefined?c=b.loaded:b[e]||a(d).jqGrid("getNodeChildren",b).length>0?c=!0:c=!1:c=!1}});return c},expandNode:function(b){return this.each(function(){if(!!this.grid&&!!this.p.treeGrid){var c=this.p.treeReader.expanded_field,d=this.p.treeReader.parent_id_field,e=this.p.treeReader.loaded,f=this.p.treeReader.level_field,g=this.p.treeReader.left_field,h=this.p.treeReader.right_field;if(!b[c]){var i=a.jgrid.getAccessor(b,this.p.localReader.id),j=a("#"+i,this.grid.bDiv)[0],k=this.p._index[i];a(this).jqGrid("isNodeLoaded",this.p.data[k])?(b[c]=!0,a("div.treeclick",j).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus")):(b[c]=!0,a("div.treeclick",j).removeClass(this.p.treeIcons.plus+" tree-plus").addClass(this.p.treeIcons.minus+" tree-minus"),this.p.treeANode=j.rowIndex,this.p.datatype=this.p.treedatatype,this.p.treeGridModel=="nested"?a(this).jqGrid("setGridParam",{postData:{nodeid:i,n_left:b[g],n_right:b[h],n_level:b[f]}}):a(this).jqGrid("setGridParam",{postData:{nodeid:i,parentid:b[d],n_level:b[f]}}),a(this).trigger("reloadGrid"),b[e]=!0,this.p.treeGridModel=="nested"?a(this).jqGrid("setGridParam",{postData:{nodeid:"",n_left:"",n_right:"",n_level:""}}):a(this).jqGrid("setGridParam",{postData:{nodeid:"",parentid:"",n_level:""}}))}}})},collapseNode:function(b){return this.each(function(){if(!!this.grid&&!!this.p.treeGrid&&b.expanded){b.expanded=!1;var c=a.jgrid.getAccessor(b,this.p.localReader.id),d=a("#"+c,this.grid.bDiv)[0];a("div.treeclick",d).removeClass(this.p.treeIcons.minus+" tree-minus").addClass(this.p.treeIcons.plus+" tree-plus")}})},SortTree:function(b,c,d,e){return this.each(function(){if(!!this.grid&&!!this.p.treeGrid){var f,g,h,i=[],j=this,k,l,m=a(this).jqGrid("getRootNodes");k=a.jgrid.from(m),k.orderBy(b,c,d,e),l=k.select();for(f=0,g=l.length;f<g;f++)h=l[f],i.push(h),a(this).jqGrid("collectChildrenSortTree",i,h,b,c,d,e);a.each(i,function(b,c){var d=a.jgrid.getAccessor(this,j.p.localReader.id);a("#"+j.p.id+" tbody tr:eq("+b+")").after(a("tr#"+d,j.grid.bDiv))}),k=null,l=null,i=null}})},collectChildrenSortTree:function(b,c,d,e,f,g){return this.each(function(){if(!!this.grid&&!!this.p.treeGrid){var h,i,j,k,l,m;k=a(this).jqGrid("getNodeChildren",c),l=a.jgrid.from(k),l.orderBy(d,e,f,g),m=l.select();for(h=0,i=m.length;h<i;h++)j=m[h],b.push(j),a(this).jqGrid("collectChildrenSortTree",b,j,d,e,f,g)}})},setTreeRow:function(b,c){var d=!1;this.each(function(){var e=this;!!e.grid&&!!e.p.treeGrid&&(d=a(e).jqGrid("setRowData",b,c))});return d},delTreeNode:function(b){return this.each(function(){var c=this,d=c.p.localReader.id,e=c.p.treeReader.left_field,f=c.p.treeReader.right_field,g,h,i,j;if(!!c.grid&&!!c.p.treeGrid){var k=c.p._index[b];if(k!==undefined){g=parseInt(c.p.data[k][f],10),h=g-parseInt(c.p.data[k][e],10)+1;var l=a(c).jqGrid("getFullTreeNode",c.p.data[k]);if(l.length>0)for(var m=0;m<l.length;m++)a(c).jqGrid("delRowData",l[m][d]);if(c.p.treeGridModel==="nested"){i=a.jgrid.from(c.p.data).greater(e,g,{stype:"integer"}).select();if(i.length)for(j in i)i[j][e]=parseInt(i[j][e],10)-h;i=a.jgrid.from(c.p.data).greater(f,g,{stype:"integer"}).select();if(i.length)for(j in i)i[j][f]=parseInt(i[j][f],10)-h}}}})},addChildNode:function(b,c,d){var e=this[0];if(d){var f=e.p.treeReader.expanded_field,g=e.p.treeReader.leaf_field,h=e.p.treeReader.level_field,i=e.p.treeReader.icon_field,j=e.p.treeReader.parent_id_field,k=e.p.treeReader.left_field,l=e.p.treeReader.right_field,m=e.p.treeReader.loaded,n,o,p,q,r,s,t=0,u=c,v,w;if(!b){r=e.p.data.length-1;if(r>=0)while(r>=0)t=Math.max(t,parseInt(e.p.data[r][e.p.localReader.id],10)),r--;b=t+1}var x=a(e).jqGrid("getInd",c);v=!1;if(c===undefined||c===null||c==="")c=null,u=null,n="last",q=e.p.tree_root_level,r=e.p.data.length+1;else{n="after",o=e.p._index[c],p=e.p.data[o],c=p[e.p.localReader.id],q=parseInt(p[h],10)+1;var y=a(e).jqGrid("getFullTreeNode",p);y.length?(r=y[y.length-1][e.p.localReader.id],u=r,r=a(e).jqGrid("getInd",u)+1):r=a(e).jqGrid("getInd",c)+1,p[g]&&(v=!0,p[f]=!0,a(e.rows[x]).find("span.cell-wrapperleaf").removeClass("cell-wrapperleaf").addClass("cell-wrapper").end().find("div.tree-leaf").removeClass(e.p.treeIcons.leaf+" tree-leaf").addClass(e.p.treeIcons.minus+" tree-minus"),e.p.data[o][g]=!1,p[m]=!0)}s=r+1,d[f]=!1,d[m]=!0,d[h]=q,d[g]=!0,e.p.treeGridModel==="adjacency"&&(d[j]=c);if(e.p.treeGridModel==="nested"){var z,A,B;if(c!==null){w=parseInt(p[l],10),z=a.jgrid.from(e.p.data),z=z.greaterOrEquals(l,w,{stype:"integer"}),A=z.select();if(A.length)for(B in A)A[B][k]=A[B][k]>w?parseInt(A[B][k],10)+2:A[B][k],A[B][l]=A[B][l]>=w?parseInt(A[B][l],10)+2:A[B][l];d[k]=w,d[l]=w+1}else{w=parseInt(a(e).jqGrid("getCol",l,!1,"max"),10),A=a.jgrid.from(e.p.data).greater(k,w,{stype:"integer"}).select();if(A.length)for(B in A)A[B][k]=parseInt(A[B][k],10)+2;A=a.jgrid.from(e.p.data).greater(l,w,{stype:"integer"}).select();if(A.length)for(B in A)A[B][l]=parseInt(A[B][l],10)+2;d[k]=w+1,d[l]=w+2}}if(c===null||a(e).jqGrid("isNodeLoaded",p)||v)a(e).jqGrid("addRowData",b,d,n,u),a(e).jqGrid("setTreeNode",r,s);p&&!p[f]&&a(e.rows[x]).find("div.treeclick").click()}}})})(jQuery)