(function(a){a.jgrid.extend({setSubGrid:function(){return this.each(function(){var b=this,c,d={plusicon:"ui-icon-plus",minusicon:"ui-icon-minus",openicon:"ui-icon-carat-1-sw",expandOnLoad:!1,delayOnLoad:50,selectOnExpand:!1,reloadOnExpand:!0};b.p.subGridOptions=a.extend(d,b.p.subGridOptions||{}),b.p.colNames.unshift(""),b.p.colModel.unshift({name:"subgrid",width:a.browser.safari?b.p.subGridWidth+b.p.cellLayout:b.p.subGridWidth,sortable:!1,resizable:!1,hidedlg:!0,search:!1,fixed:!0}),c=b.p.subGridModel;if(c[0]){c[0].align=a.extend([],c[0].align||[]);for(var e=0;e<c[0].name.length;e++)c[0].align[e]=c[0].align[e]||"left"}})},addSubGridCell:function(a,b){var c="",d,e;this.each(function(){c=this.formatCol(a,b),e=this.p.id,d=this.p.subGridOptions.plusicon});return'<td role="grid" aria-describedby="'+e+'_subgrid" class="ui-sgcollapsed sgcollapsed" '+c+"><a href='javascript:void(0);'><span class='ui-icon "+d+"'></span></a></td>"},addSubGrid:function(b,c){return this.each(function(){var d=this;if(!!d.grid){var e=function(b,c,e){var f=a("<td align='"+d.p.subGridModel[0].align[e]+"'></td>").html(c);a(b).append(f)},f=function(b,c){var f,g,h,i=a("<table cellspacing='0' cellpadding='0' border='0'><tbody></tbody></table>"),j=a("<tr></tr>");for(g=0;g<d.p.subGridModel[0].name.length;g++)f=a("<th class='ui-state-default ui-th-subgrid ui-th-column ui-th-"+d.p.direction+"'></th>"),a(f).html(d.p.subGridModel[0].name[g]),a(f).width(d.p.subGridModel[0].width[g]),a(j).append(f);a(i).append(j),b&&(h=d.p.xmlReader.subgrid,a(h.root+" "+h.row,b).each(function(){j=a("<tr class='ui-widget-content ui-subtblcell'></tr>");if(h.repeatitems===!0)a(h.cell,this).each(function(b){e(j,a(this).text()||"&#160;",b)});else{var b=d.p.subGridModel[0].mapping||d.p.subGridModel[0].name;if(b)for(g=0;g<b.length;g++)e(j,a(b[g],this).text()||"&#160;",g)}a(i).append(j)}));var k=a("table:first",d.grid.bDiv).attr("id")+"_";a("#"+k+c).append(i),d.grid.hDiv.loading=!1,a("#load_"+d.p.id).hide();return!1},g=function(b,c){var f,g,h,i,j,k,l=a("<table cellspacing='0' cellpadding='0' border='0'><tbody></tbody></table>"),m=a("<tr></tr>");for(h=0;h<d.p.subGridModel[0].name.length;h++)f=a("<th class='ui-state-default ui-th-subgrid ui-th-column ui-th-"+d.p.direction+"'></th>"),a(f).html(d.p.subGridModel[0].name[h]),a(f).width(d.p.subGridModel[0].width[h]),a(m).append(f);a(l).append(m);if(b){j=d.p.jsonReader.subgrid,g=b[j.root];if(typeof g!="undefined")for(h=0;h<g.length;h++){i=g[h],m=a("<tr class='ui-widget-content ui-subtblcell'></tr>");if(j.repeatitems===!0){j.cell&&(i=i[j.cell]);for(k=0;k<i.length;k++)e(m,i[k]||"&#160;",k)}else{var n=d.p.subGridModel[0].mapping||d.p.subGridModel[0].name;if(n.length)for(k=0;k<n.length;k++)e(m,i[n[k]]||"&#160;",k)}a(l).append(m)}}var o=a("table:first",d.grid.bDiv).attr("id")+"_";a("#"+o+c).append(l),d.grid.hDiv.loading=!1,a("#load_"+d.p.id).hide();return!1},h=function(b){var c,e,h,i;c=a(b).attr("id"),e={nd_:(new Date).getTime()},e[d.p.prmNames.subgridid]=c;if(!d.p.subGridModel[0])return!1;if(d.p.subGridModel[0].params)for(i=0;i<d.p.subGridModel[0].params.length;i++)for(h=0;h<d.p.colModel.length;h++)d.p.colModel[h].name==d.p.subGridModel[0].params[i]&&(e[d.p.colModel[h].name]=a("td:eq("+h+")",b).text().replace(/\&#160\;/ig,""));if(!d.grid.hDiv.loading){d.grid.hDiv.loading=!0,a("#load_"+d.p.id).show(),d.p.subgridtype||(d.p.subgridtype=d.p.datatype),a.isFunction(d.p.subgridtype)?d.p.subgridtype.call(d,e):d.p.subgridtype=d.p.subgridtype.toLowerCase();switch(d.p.subgridtype){case"xml":case"json":a.ajax(a.extend({type:d.p.mtype,url:d.p.subGridUrl,dataType:d.p.subgridtype,data:a.isFunction(d.p.serializeSubGridData)?d.p.serializeSubGridData.call(d,e):e,complete:function(b){d.p.subgridtype=="xml"?f(b.responseXML,c):g(a.jgrid.parse(b.responseText),c),b=null}},a.jgrid.ajaxOptions,d.p.ajaxSubgridOptions||{}))}}return!1},i,j,k,l=0,m,n;a.each(d.p.colModel,function(a,b){(this.hidden===!0||this.name=="rn"||this.name=="cb")&&l++});var o=d.rows.length,p=1;c!==undefined&&c>0&&(p=c,o=c+1);while(p<o)a(d.rows[p]).hasClass("jqgrow")&&a(d.rows[p].cells[b]).bind("click",function(c){var e=a(this).parent("tr")[0];n=e.nextSibling;if(a(this).hasClass("sgcollapsed")){j=d.p.id,i=e.id;if(d.p.subGridOptions.reloadOnExpand===!0||d.p.subGridOptions.reloadOnExpand===!1&&!a(n).hasClass("ui-subgrid")){k=b>=1?"<td colspan='"+b+"'>&#160;</td>":"",m=!0,a.isFunction(d.p.subGridBeforeExpand)&&(m=d.p.subGridBeforeExpand.call(d,j+"_"+i,i));if(m===!1)return!1;a(e).after("<tr role='row' class='ui-subgrid'>"+k+"<td class='ui-widget-content subgrid-cell'><span class='ui-icon "+d.p.subGridOptions.openicon+"'></span></td><td colspan='"+parseInt(d.p.colNames.length-1-l,10)+"' class='ui-widget-content subgrid-data'><div id="+j+"_"+i+" class='tablediv'></div></td></tr>"),a.isFunction(d.p.subGridRowExpanded)?d.p.subGridRowExpanded.call(d,j+"_"+i,i):h(e)}else a(n).show();a(this).html("<a href='javascript:void(0);'><span class='ui-icon "+d.p.subGridOptions.minusicon+"'></span></a>").removeClass("sgcollapsed").addClass("sgexpanded"),d.p.subGridOptions.selectOnExpand&&a(d).jqGrid("setSelection",i)}else if(a(this).hasClass("sgexpanded")){m=!0,a.isFunction(d.p.subGridRowColapsed)&&(i=e.id,m=d.p.subGridRowColapsed.call(d,j+"_"+i,i));if(m===!1)return!1;d.p.subGridOptions.reloadOnExpand===!0?a(n).remove(".ui-subgrid"):a(n).hasClass("ui-subgrid")&&a(n).hide(),a(this).html("<a href='javascript:void(0);'><span class='ui-icon "+d.p.subGridOptions.plusicon+"'></span></a>").removeClass("sgexpanded").addClass("sgcollapsed")}return!1}),d.p.subGridOptions.expandOnLoad===!0&&a(d.rows[p].cells[b]).trigger("click"),p++;d.subGridXml=function(a,b){f(a,b)},d.subGridJson=function(a,b){g(a,b)}}})},expandSubGridRow:function(b){return this.each(function(){var c=this;if(!!c.grid||!!b)if(c.p.subGrid===!0){var d=a(this).jqGrid("getInd",b,!0);if(d){var e=a("td.sgcollapsed",d)[0];e&&a(e).trigger("click")}}})},collapseSubGridRow:function(b){return this.each(function(){var c=this;if(!!c.grid||!!b)if(c.p.subGrid===!0){var d=a(this).jqGrid("getInd",b,!0);if(d){var e=a("td.sgexpanded",d)[0];e&&a(e).trigger("click")}}})},toggleSubGridRow:function(b){return this.each(function(){var c=this;if(!!c.grid||!!b)if(c.p.subGrid===!0){var d=a(this).jqGrid("getInd",b,!0);if(d){var e=a("td.sgcollapsed",d)[0];e?a(e).trigger("click"):(e=a("td.sgexpanded",d)[0],e&&a(e).trigger("click"))}}})}})})(jQuery)