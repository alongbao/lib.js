(function(a){a.jgrid.extend({editCell:function(b,c,d){return this.each(function(){var e=this,f,g,h,i;if(!!e.grid&&e.p.cellEdit===!0){c=parseInt(c,10),e.p.selrow=e.rows[b].id,e.p.knv||a(e).jqGrid("GridNav");if(e.p.savedRow.length>0){if(d===!0&&b==e.p.iRow&&c==e.p.iCol)return;a(e).jqGrid("saveCell",e.p.savedRow[0].id,e.p.savedRow[0].ic)}else window.setTimeout(function(){a("#"+e.p.knv).attr("tabindex","-1").focus()},0);i=e.p.colModel[c],f=i.name;if(f=="subgrid"||f=="cb"||f=="rn")return;h=a("td:eq("+c+")",e.rows[b]);if(i.editable===!0&&d===!0&&!h.hasClass("not-editable-cell")){parseInt(e.p.iCol,10)>=0&&parseInt(e.p.iRow,10)>=0&&(a("td:eq("+e.p.iCol+")",e.rows[e.p.iRow]).removeClass("edit-cell ui-state-highlight"),a(e.rows[e.p.iRow]).removeClass("selected-row ui-state-hover")),a(h).addClass("edit-cell ui-state-highlight"),a(e.rows[b]).addClass("selected-row ui-state-hover");try{g=a.unformat(h,{rowId:e.rows[b].id,colModel:i},c)}catch(j){g=i.edittype&&i.edittype=="textarea"?a(h).text():a(h).html()}e.p.autoencode&&(g=a.jgrid.htmlDecode(g)),i.edittype||(i.edittype="text"),e.p.savedRow.push({id:b,ic:c,name:f,v:g});if(g=="&nbsp;"||g=="&#160;"||g.length==1&&g.charCodeAt(0)==160)g="";if(a.isFunction(e.p.formatCell)){var k=e.p.formatCell.call(e,e.rows[b].id,f,g,b,c);k!==undefined&&(g=k)}var l=a.extend({},i.editoptions||{},{id:b+"_"+f,name:f}),m=a.jgrid.createEl(i.edittype,l,g,!0,a.extend({},a.jgrid.ajaxOptions,e.p.ajaxSelectOptions||{}));a.isFunction(e.p.beforeEditCell)&&e.p.beforeEditCell.call(e,e.rows[b].id,f,g,b,c),a(h).html("").append(m).attr("tabindex","0"),window.setTimeout(function(){a(m).focus()},0),a("input, select, textarea",h).bind("keydown",function(d){d.keyCode===27&&(a("input.hasDatepicker",h).length>0?a(".ui-datepicker").is(":hidden")?a(e).jqGrid("restoreCell",b,c):a("input.hasDatepicker",h).datepicker("hide"):a(e).jqGrid("restoreCell",b,c)),d.keyCode===13&&a(e).jqGrid("saveCell",b,c);if(d.keyCode==9)if(!e.grid.hDiv.loading)d.shiftKey?a(e).jqGrid("prevCell",b,c):a(e).jqGrid("nextCell",b,c);else return!1;d.stopPropagation()}),a.isFunction(e.p.afterEditCell)&&e.p.afterEditCell.call(e,e.rows[b].id,f,g,b,c)}else parseInt(e.p.iCol,10)>=0&&parseInt(e.p.iRow,10)>=0&&(a("td:eq("+e.p.iCol+")",e.rows[e.p.iRow]).removeClass("edit-cell ui-state-highlight"),a(e.rows[e.p.iRow]).removeClass("selected-row ui-state-hover")),h.addClass("edit-cell ui-state-highlight"),a(e.rows[b]).addClass("selected-row ui-state-hover"),a.isFunction(e.p.onSelectCell)&&(g=h.html().replace(/\&#160\;/ig,""),e.p.onSelectCell.call(e,e.rows[b].id,f,g,b,c));e.p.iCol=c,e.p.iRow=b}})},saveCell:function(b,c){return this.each(function(){var d=this,e;if(!!d.grid&&d.p.cellEdit===!0){d.p.savedRow.length>=1?e=0:e=null;if(e!==null){var f=a("td:eq("+c+")",d.rows[b]),g,h,i=d.p.colModel[c],j=i.name,k=a.jgrid.jqID(j);switch(i.edittype){case"select":if(!i.editoptions.multiple)g=a("#"+b+"_"+k+">option:selected",d.rows[b]).val(),h=a("#"+b+"_"+k+">option:selected",d.rows[b]).text();else{var l=a("#"+b+"_"+k,d.rows[b]),m=[];g=a(l).val(),g?g.join(","):g="",a("option:selected",l).each(function(b,c){m[b]=a(c).text()}),h=m.join(",")}i.formatter&&(h=g);break;case"checkbox":var n=["Yes","No"];i.editoptions&&(n=i.editoptions.value.split(":")),g=a("#"+b+"_"+k,d.rows[b]).attr("checked")?n[0]:n[1],h=g;break;case"password":case"text":case"textarea":case"button":g=a("#"+b+"_"+k,d.rows[b]).val(),h=g;break;case"custom":try{if(!i.editoptions||!a.isFunction(i.editoptions.custom_value))throw"e1";g=i.editoptions.custom_value.call(d,a(".customelement",f),"get");if(g===undefined)throw"e2";h=g}catch(o){o=="e1"&&a.jgrid.info_dialog(jQuery.jgrid.errors.errcap,"function 'custom_value' "+a.jgrid.edit.msg.nodefined,jQuery.jgrid.edit.bClose),o=="e2"?a.jgrid.info_dialog(jQuery.jgrid.errors.errcap,"function 'custom_value' "+a.jgrid.edit.msg.novalue,jQuery.jgrid.edit.bClose):a.jgrid.info_dialog(jQuery.jgrid.errors.errcap,o.message,jQuery.jgrid.edit.bClose)}}if(h!==d.p.savedRow[e].v){if(a.isFunction(d.p.beforeSaveCell)){var p=d.p.beforeSaveCell.call(d,d.rows[b].id,j,g,b,c);p&&(g=p,h=p)}var q=a.jgrid.checkValues(g,c,d);if(q[0]===!0){var r={};a.isFunction(d.p.beforeSubmitCell)&&(r=d.p.beforeSubmitCell.call(d,d.rows[b].id,j,g,b,c),r||(r={})),a("input.hasDatepicker",f).length>0&&a("input.hasDatepicker",f).datepicker("hide");if(d.p.cellsubmit=="remote")if(d.p.cellurl){var s={};d.p.autoencode&&(g=a.jgrid.htmlEncode(g)),s[j]=g;var t,u,v;v=d.p.prmNames,t=v.id,u=v.oper,s[t]=d.rows[b].id,s[u]=v.editoper,s=a.extend(r,s),a("#lui_"+d.p.id).show(),d.grid.hDiv.loading=!0,a.ajax(a.extend({url:d.p.cellurl,data:a.isFunction(d.p.serializeCellData)?d.p.serializeCellData.call(d,s):s,type:"POST",complete:function(e,i){a("#lui_"+d.p.id).hide(),d.grid.hDiv.loading=!1;if(i=="success")if(a.isFunction(d.p.afterSubmitCell)){var k=d.p.afterSubmitCell.call(d,e,s.id,j,g,b,c);k[0]===!0?(a(f).empty(),a(d).jqGrid("setCell",d.rows[b].id,c,h,!1,!1,!0),a(f).addClass("dirty-cell"),a(d.rows[b]).addClass("edited"),a.isFunction(d.p.afterSaveCell)&&d.p.afterSaveCell.call(d,d.rows[b].id,j,g,b,c),d.p.savedRow.splice(0,1)):(a.jgrid.info_dialog(a.jgrid.errors.errcap,k[1],a.jgrid.edit.bClose),a(d).jqGrid("restoreCell",b,c))}else a(f).empty(),a(d).jqGrid("setCell",d.rows[b].id,c,h,!1,!1,!0),a(f).addClass("dirty-cell"),a(d.rows[b]).addClass("edited"),a.isFunction(d.p.afterSaveCell)&&d.p.afterSaveCell.call(d,d.rows[b].id,j,g,b,c),d.p.savedRow.splice(0,1)},error:function(e,f){a("#lui_"+d.p.id).hide(),d.grid.hDiv.loading=!1,a.isFunction(d.p.errorCell)?(d.p.errorCell.call(d,e,f),a(d).jqGrid("restoreCell",b,c)):(a.jgrid.info_dialog(a.jgrid.errors.errcap,e.status+" : "+e.statusText+"<br/>"+f,a.jgrid.edit.bClose),a(d).jqGrid("restoreCell",b,c))}},a.jgrid.ajaxOptions,d.p.ajaxCellOptions||{}))}else try{a.jgrid.info_dialog(a.jgrid.errors.errcap,a.jgrid.errors.nourl,a.jgrid.edit.bClose),a(d).jqGrid("restoreCell",b,c)}catch(o){}d.p.cellsubmit=="clientArray"&&(a(f).empty(),a(d).jqGrid("setCell",d.rows[b].id,c,h,!1,!1,!0),a(f).addClass("dirty-cell"),a(d.rows[b]).addClass("edited"),a.isFunction(d.p.afterSaveCell)&&d.p.afterSaveCell.call(d,d.rows[b].id,j,g,b,c),d.p.savedRow.splice(0,1))}else try{window.setTimeout(function(){a.jgrid.info_dialog(a.jgrid.errors.errcap,g+" "+q[1],a.jgrid.edit.bClose)},100),a(d).jqGrid("restoreCell",b,c)}catch(o){}}else a(d).jqGrid("restoreCell",b,c)}a.browser.opera?a("#"+d.p.knv).attr("tabindex","-1").focus():window.setTimeout(function(){a("#"+d.p.knv).attr("tabindex","-1").focus()},0)}})},restoreCell:function(b,c){return this.each(function(){var d=this,e;if(!!d.grid&&d.p.cellEdit===!0){d.p.savedRow.length>=1?e=0:e=null;if(e!==null){var f=a("td:eq("+c+")",d.rows[b]);if(a.isFunction(a.fn.datepicker))try{a("input.hasDatepicker",f).datepicker("hide")}catch(g){}a(f).empty().attr("tabindex","-1"),a(d).jqGrid("setCell",d.rows[b].id,c,d.p.savedRow[e].v,!1,!1,!0),a.isFunction(d.p.afterRestoreCell)&&d.p.afterRestoreCell.call(d,d.rows[b].id,d.p.savedRow[e].v,b,c),d.p.savedRow.splice(0,1)}window.setTimeout(function(){a("#"+d.p.knv).attr("tabindex","-1").focus()},0)}})},nextCell:function(b,c){return this.each(function(){var d=this,e=!1;if(!!d.grid&&d.p.cellEdit===!0){for(var f=c+1;f<d.p.colModel.length;f++)if(d.p.colModel[f].editable===!0){e=f;break}e!==!1?a(d).jqGrid("editCell",b,e,!0):d.p.savedRow.length>0&&a(d).jqGrid("saveCell",b,c)}})},prevCell:function(b,c){return this.each(function(){var d=this,e=!1;if(!!d.grid&&d.p.cellEdit===!0){for(var f=c-1;f>=0;f--)if(d.p.colModel[f].editable===!0){e=f;break}e!==!1?a(d).jqGrid("editCell",b,e,!0):d.p.savedRow.length>0&&a(d).jqGrid("saveCell",b,c)}})},GridNav:function(){return this.each(function(){function g(a,c){var d,e;if(c=="lft"){d=a+1;for(e=a;e>=0;e--)if(b.p.colModel[e].hidden!==!0){d=e;break}}if(c=="rgt"){d=a-1;for(e=a;e<b.p.colModel.length;e++)if(b.p.colModel[e].hidden!==!0){d=e;break}}return d}function f(c,d,e){if(e.substr(0,1)=="v"){var f=a(b.grid.bDiv)[0].clientHeight,g=a(b.grid.bDiv)[0].scrollTop,h=b.rows[c].offsetTop+b.rows[c].clientHeight,i=b.rows[c].offsetTop;e=="vd"&&h>=f&&(a(b.grid.bDiv)[0].scrollTop=a(b.grid.bDiv)[0].scrollTop+b.rows[c].clientHeight),e=="vu"&&i<g&&(a(b.grid.bDiv)[0].scrollTop=a(b.grid.bDiv)[0].scrollTop-b.rows[c].clientHeight)}if(e=="h"){var j=a(b.grid.bDiv)[0].clientWidth,k=a(b.grid.bDiv)[0].scrollLeft,l=b.rows[c].cells[d].offsetLeft+b.rows[c].cells[d].clientWidth,m=b.rows[c].cells[d].offsetLeft;l>=j+parseInt(k,10)?a(b.grid.bDiv)[0].scrollLeft=a(b.grid.bDiv)[0].scrollLeft+b.rows[c].cells[d].clientWidth:m<k&&(a(b.grid.bDiv)[0].scrollLeft=a(b.grid.bDiv)[0].scrollLeft-b.rows[c].cells[d].clientWidth)}}var b=this;if(!!b.grid&&b.p.cellEdit===!0){b.p.knv=b.p.id+"_kn";var c=a("<span style='width:0px;height:0px;background-color:black;' tabindex='0'><span tabindex='-1' style='width:0px;height:0px;background-color:grey' id='"+b.p.knv+"'></span></span>"),d,e;a(c).insertBefore(b.grid.cDiv),a("#"+b.p.knv).focus().keydown(function(c){e=c.keyCode,b.p.direction=="rtl"&&(e==37?e=39:e==39&&(e=37));switch(e){case 38:b.p.iRow-1>0&&(f(b.p.iRow-1,b.p.iCol,"vu"),a(b).jqGrid("editCell",b.p.iRow-1,b.p.iCol,!1));break;case 40:b.p.iRow+1<=b.rows.length-1&&(f(b.p.iRow+1,b.p.iCol,"vd"),a(b).jqGrid("editCell",b.p.iRow+1,b.p.iCol,!1));break;case 37:b.p.iCol-1>=0&&(d=g(b.p.iCol-1,"lft"),f(b.p.iRow,d,"h"),a(b).jqGrid("editCell",b.p.iRow,d,!1));break;case 39:b.p.iCol+1<=b.p.colModel.length-1&&(d=g(b.p.iCol+1,"rgt"),f(b.p.iRow,d,"h"),a(b).jqGrid("editCell",b.p.iRow,d,!1));break;case 13:parseInt(b.p.iCol,10)>=0&&parseInt(b.p.iRow,10)>=0&&a(b).jqGrid("editCell",b.p.iRow,b.p.iCol,!0)}return!1})}})},getChangedCells:function(b){var c=[];b||(b="all"),this.each(function(){var d=this,e;!!d.grid&&d.p.cellEdit===!0&&a(d.rows).each(function(f){var g={};a(this).hasClass("edited")&&(a("td",this).each(function(c){e=d.p.colModel[c].name;if(e!=="cb"&&e!=="subgrid")if(b=="dirty"){if(a(this).hasClass("dirty-cell"))try{g[e]=a.unformat(this,{rowId:d.rows[f].id,colModel:d.p.colModel[c]},c)}catch(h){g[e]=a.jgrid.htmlDecode(a(this).html())}}else try{g[e]=a.unformat(this,{rowId:d.rows[f].id,colModel:d.p.colModel[c]},c)}catch(h){g[e]=a.jgrid.htmlDecode(a(this).html())}}),g.id=this.id,c.push(g))})});return c}})})(jQuery)